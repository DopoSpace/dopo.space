// Prisma Schema for Dopo Space Membership Management System

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum MembershipStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

// Models

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?  // Optional display name for audit trails
  password  String   @map("password")

  // Session invalidation (for logout from all devices)
  sessionsInvalidatedAt DateTime? @map("sessions_invalidated_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admins")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String?

  // Preferred locale for emails (it/en)
  preferredLocale String? @default("it") @map("preferred_locale")

  // Newsletter management
  newsletterSubscribed Boolean @default(false) @map("newsletter_subscribed")
  mailchimpSubscriberId String? @map("mailchimp_subscriber_id")

  // Session invalidation (for logout from all devices)
  sessionsInvalidatedAt DateTime? @map("sessions_invalidated_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  profile     UserProfile?
  memberships Membership[]

  @@index([createdAt])
  @@map("users")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")

  // Personal information
  firstName   String    @map("first_name")
  lastName    String    @map("last_name")
  birthDate   DateTime? @map("birth_date") // Optional until profile completion
  taxCode     String?   @map("tax_code") // Codice Fiscale

  // Birth place information (for AICS export)
  nationality       String?  @map("nationality") // "IT" for Italian, country code for others
  birthProvince     String?  @map("birth_province") // 2 letters (e.g., "MI") or "EE" for foreign
  birthCity         String?  @map("birth_city") // City name or "Paese Origine Estero" for foreign
  hasForeignTaxCode Boolean  @default(false) @map("has_foreign_tax_code") // Foreign national with Italian CF

  // Gender (required for foreigners without tax code, since it cannot be derived from CF)
  gender String? @map("gender") // "M" for male, "F" for female

  // Address (optional until profile completion)
  address          String? // Made optional to avoid placeholder values
  city             String? // Made optional to avoid placeholder values
  postalCode       String? @map("postal_code") // Made optional to avoid placeholder values
  province         String? // Made optional to avoid placeholder values
  residenceCountry String? @default("IT") @map("residence_country") // "IT" for Italy, ISO code for others

  // Contact information
  phone String? // Mobile phone (optional)

  // Document information (optional for digital card)
  documentType   String? @map("document_type")
  documentNumber String? @map("document_number")

  // Consents (nullable - must be explicitly given by user)
  // NULL means consent not yet given, FALSE means explicitly declined, TRUE means accepted
  privacyConsent Boolean? @map("privacy_consent")
  dataConsent    Boolean? @map("data_consent")

  // Computed field (can be calculated in application logic)
  profileComplete Boolean @default(false) @map("profile_complete")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([firstName])
  @@index([lastName])
  @@index([profileComplete])
  @@map("user_profiles")
}

// Application settings (key-value store)
model Settings {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model CardNumberRange {
  id String @id @default(cuid())

  // Range definition
  prefix      String @default("")
  startNumber Int    @map("start_number")
  endNumber   Int    @map("end_number")
  padding     Int    @default(3) // Per formattare 001, 002, etc.

  // Tracking
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") // Admin ID

  @@map("card_number_ranges")
}

model Membership {
  id     String @id @default(cuid())
  userId String @map("user_id")

  // Membership card number (assigned by admin after payment)
  membershipNumber         String?   @unique @map("membership_number")
  previousMembershipNumber String?   @map("previous_membership_number") // Stored when membership expires or is canceled
  cardAssignedAt           DateTime? @map("card_assigned_at") // When the card number was assigned

  // Validity period (365 days from activation)
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")

  // Status
  status        MembershipStatus @default(PENDING)
  paymentStatus PaymentStatus    @default(PENDING) @map("payment_status")

  // Payment information
  paymentProviderId String? @map("payment_provider_id")
  paymentAmount     Int?    @map("payment_amount") // in cents

  // Audit trail
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by") // Admin ID who updated (for audit)

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentLogs PaymentLog[]

  @@map("memberships")
  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
}

model PaymentLog {
  id           String   @id @default(cuid())
  membershipId String   @map("membership_id")

  // Event information
  eventType        String  @map("event_type")
  providerEventId  String? @unique @map("provider_event_id") // PayPal event ID for idempotency
  providerResponse Json    @map("provider_response")

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  membership Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@map("payment_logs")
  @@index([membershipId])
}

model UsedToken {
  id String @id @default(cuid())

  // Token identifier (JWT jti claim)
  tokenId String @unique @map("token_id")

  // Token type for different use cases
  tokenType String @map("token_type") // 'magic-link', 'password-reset', etc.

  // Associated email for audit trail
  email String

  // When the token was used
  usedAt DateTime @default(now()) @map("used_at")

  // When the token expires (for cleanup)
  expiresAt DateTime @map("expires_at")

  @@map("used_tokens")
  @@index([tokenId])
  @@index([expiresAt]) // For cleanup queries
}
